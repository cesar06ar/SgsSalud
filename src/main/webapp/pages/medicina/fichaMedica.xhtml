<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      template="/WEB-INF/view/templates/glue.xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:s="http://jboss.org/seam/faces"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      xmlns:p="http://primefaces.org/ui"      
      xmlns:pe="http://primefaces.org/ui/extensions"
      xmlns:glue="http://eqaula.org/jsf/facelets"
      xmlns:ocp="http://java.sun.com/jsf/composite/ocpcommon">

    <ui:composition template="/WEB-INF/view/templates/glue.xhtml">
        <f:metadata>
            <f:viewParam name="pacienteId" value="#{fichaMedicaHome.pacienteId}" />
            <f:viewParam name="fichaMedicaId" value="#{fichaMedicaHome.fichaMedicaId}" />
            <f:viewParam name="backView" value="#{fichaMedicaHome.backView}" />
        </f:metadata>

        <ui:define name="header-replace">
            <div class="header-replace">
                <div class="container">
                    <div class="row fl" style="margin-top: 5px;">
                        <h2>#{fichaMedicaHome.managed? messages['common.edit'] : messages['common.add']} #{fichaMedicaHome.instance.numeroFicha}</h2>   
                    </div>
                </div>
            </div>
        </ui:define>
        <ui:define name="content" class="span20">            
            <h:form id="form">
                <p:messages id="messages1" showDetail="true" autoUpdate="true" closable="true" />  
                <div class="columns offset7" >
                    <h:panelGrid id="buscarp" class="clearfix" columns="3" style="margin: -12px 0px -6px -20px; ">
                        <label for="buscar">#{'Buscar por'}</label>
                        <script type="text/javascript">
                            $(document).ready(function() {
                                $('#form\\:buscar').attr("placeholder", "N&ordm; de ficha, cedula");                                
                            });
                        </script>
                        <h:inputText id="buscar" value="#{fichaMedicaHome.parametroBusqueda}" styleClass="span5" required="true" label="" >                                                                                
                            <f:ajax execute="@this" render="buscarp" />                                
                        </h:inputText>                                                                   
                        <p:commandLink id="cargar" actionListener="#{fichaMedicaHome.buscarPorParametro()}" ajax="true"
                                       title="Buscar Paciente"  styleClass="btn primary" style="height: 16px;">                                                                               
                            <p:graphicImage value="#{resource['/images/buscar.png']}" style="margin-top: -2px;"/>
                            <p:ajax process="@this" update=":form:infoP :form:infoFM" rendered=":form:infoP :form:infoFM" />
                        </p:commandLink>                       
                    </h:panelGrid>
                </div>
                <p:panel id="infoP" header="Información Personal" styleClass="clearfix">
                    <div class="row fl" >
                        <div class="span2 columns " style="margin-left: 15px;">
                            <h:link outcome="/pages/paciente/paciente" title="#{fichaMedicaHome.paciente.nombres}">
                                <!--<ocp:gravatar email="#{fichaMedicaHome.paciente.email}" size="100" updatable="true" />-->
                                <f:param name="pacienteId" value="#{fichaMedicaHome.paciente.id}"/>
                            </h:link>
                        </div>
                    </div>
                    <div class="container-fluid">   
                        <div class="row-fluid">
                            <div class="span7">
                                <glue:output id="nfm" name="nficha" type="text" label="#{messages['fichaMedica.numero']}" value="#{fichaMedicaHome.instance.numeroFicha}" required="true" execute="@this save" render="nfm" styleClass="xLarge" disabled="true"/>
                                <glue:output id="fstn" name="nombres" type="text" label="#{messages['common.firstname']}" value="#{fichaMedicaHome.paciente.nombres}" required="false" execute="@this save" render="fstn" styleClass="xLarge" disabled="true"/>
                                <glue:output id="srn" name="apellidos" type="text" label="#{messages['common.surname']}" value="#{fichaMedicaHome.paciente.apellidos}" required="false" execute="@this save" render="srn" styleClass="xLarge" disabled="true"/>                                      
                                <glue:output id="genero" name="genero" type="select" label="#{messages['comun.genero']}" value="#{fichaMedicaHome.paciente.genero}" values="#{fichaMedicaHome.listaGeneros}" converter="#{omnifaces.GenericEnumConverter}" 
                                             required="false" execute="@this save" render="genero" styleClass="xLarge" disabled="true"/>                                      
                            </div>
                            <div class="span7" align="left">                                                                
                                <h:panelGroup layout="block" class="clearfix" >
                                    <label for="fafm" >#{messages['fichaMedica.fechaApertura']}"</label>
                                    <div class="input">                                                         
                                        <p:calendar id="fafm" value="#{fichaMedicaHome.instance.fechaApertura}"  label="#{messages['fichaMedica.fechaApertura']}" 
                                                    disabled="true" pattern="dd-MMM-yyyy">                                            
                                        </p:calendar>                                                                                                      
                                        <h:graphicImage value="#{resource['success.gif']}" rendered="#{fichaMedicaHome.instance.fechaApertura != null}"
                                                        styleClass="validation-status" />                                                        
                                    </div>
                                </h:panelGroup> 
                                <ui:repeat value="#{fichaMedicaHome.paciente.findBussinesEntityAttribute('datosPersonalesPaciente')}" var="attrib" varStatus="status">
                                    <h:panelGroup layout="block" class="clearfix" rendered="#{attrib.name eq 'estadoCivil'}">
                                        <label for="#{a.name}" class="#{(not empty attrib.property.required and attrib.property.required) ? 'required' : ''}">#{attrib.property.label}#{(not empty attrib.property.required and attrib.property.required) ? '*&#160;' : ''}</label>
                                        <div class="input">                                                         
                                            <p:selectOneMenu value="#{attrib.value}" effect="fade"  converter="#{omnifaces.SelectItemsConverter}" required="#{attrib.property.required}" requiredMessage="#{attrib.property.requiredMessage}" label="#{attrib.property.label}"
                                                             rendered="#{attrib.property.type eq 'java.lang.String[]'}" disabled="#{not empty attrib}" styleClass="xLarge">  
                                                <f:selectItems value="#{ui.getValuesAsSelectItem(attrib.property.values)}" var="v" itemLabel="#{v.label}" itemValue="#{v}"/>  
                                                <p:ajax event="change" update="@parent" partialSubmit="true"/>
                                            </p:selectOneMenu>                                                                                                       
                                            <h:graphicImage value="#{resource['success.gif']}" rendered="#{attrib.value != null}"
                                                            styleClass="validation-status" />                                                        
                                        </div>
                                    </h:panelGroup>   
                                </ui:repeat>    
                                <h:panelGroup id="fnp" layout="block" class="clearfix">
                                    <label for="fnacim">#{messages['common.fecha.nacimiento']}</label>
                                    <div class="input" >
                                        <p:calendar  id="fnacim" value="#{fichaMedicaHome.paciente.fechaNacimiento}" styleClass="xLarge" required="false" label="edad" 
                                                     rendered="true" pattern="dd-MMM-yyyy" disabled="true" >
                                            <p:ajax event="dateSelect" rendered="fnp " update="@parent fnp" />  
                                        </p:calendar>      
                                        <h:graphicImage value="#{resource['success.gif']}" rendered="#{fichaMedicaHome.paciente.fechaNacimiento != null}"
                                                        styleClass="validation-status" />
                                    </div>
                                </h:panelGroup>
                                <glue:output id="edad" name="edad" type="deciamal" label="#{messages['common.edad']}" value="#{fichaMedicaHome.paciente.edad}" required="false" execute="@this save" render="edad" styleClass="xLarge" disabled="true"/>
                            </div>
                        </div>
                    </div>
                </p:panel>
                <p:separator id="separador1" style="margin-top: 0px; height:8px; margin-bottom: 0px;" styleClass="clearfix"/>

                <!--DATOS DE LA HISTORIA CLINICA-->               
                <p:accordionPanel id="infoFM" styleClass="span17" dynamic="true" multiple="true" >                        
                    <p:tab title="#{'INFORMACIÓN MÉDICA GENERAL'}">
                        <h:panelGroup layout="block" class="clearfix">
                            <label for="gs_" class="control-label">#{messages['fichaMedica.grupoSangineo']}</label>
                            <div class="input">
                                <p:selectOneMenu id="gs_" value="#{fichaMedicaHome.instance.grupoSangineo}" effect="fade"  converter="#{omnifaces.GenericEnumConverter}" required="false" requiredMessage="false" 
                                                 rendered="true" label="#{messages['fichaMedica.grupoSanguineo']}">
                                    <f:selectItem  itemLabel = "#{messages['common.choice']}"  ItemValue = ""  />  
                                    <f:selectItems value="#{fichaMedicaHome.listaGruposSangineos}" var="grupoS" itemLabel="#{grupoS}" itemValue="#{grupoS}"/>                          
                                    <p:ajax event="change" update="@parent" partialSubmit="true" process="@this"/>
                                </p:selectOneMenu>  
                                <h:graphicImage value="#{resource['success.gif']}" rendered="#{fichaMedicaHome.instance.grupoSangineo != null}"
                                                styleClass="validation-status" />
                                <span class="help-inline"><br/>#{messages['fichaMedica.grupoSanguineo.lineaAyuda']} <ocp:message forId="gs_" /></span>
                            </div>
                        </h:panelGroup>
                    </p:tab>

                    <c:forEach items="#{ui.getProperties(fichaMedicaHome.instance)}" var="f" >                        
                        <p:tab title="#{f.label}" titleStyleClass="clearfix" 
                               rendered="#{(f.name eq 'antecedentesPersonalesFichaMedica' and account.tienePermiso('ENFERMEROS')) or (f.name eq 'antecedentesFamiliaresFichaMedica' and  account.tienePermiso('ENFERMEROS'))}">
                            <c:choose>
                                <c:when test="#{f.type == 'edu.sgssalud.model.Structure'}">                                
                                    <ui:repeat value="#{fichaMedicaHome.instance.findBussinesEntityAttribute(f.name)}" var="a" varStatus="status">

                                        <c:choose>
                                            <c:when test="${f.name eq 'habitosFichaMedica'}">
                                                <h:panelGroup rendered="#{not a.property.survey}" layout="block" styleClass="clearfix">
                                                    <label for="#{a.name}" class="#{(not empty a.property.required and a.property.required) ? 'required' : ''}"><strong>#{a.property.label}#{(not empty a.property.required and a.property.required) ? '*&#160;' : '&nbsp;'}</strong></label>                                            
                                                    <div class="input" >                                                                                     

                                                        <p:inputTextarea value="#{a.value}" styleClass="xLarge span4" required="#{a.property.required}" label="#{a.property.label}" style="width: 400px; height: 100px;" 
                                                                         rendered="#{a.property.type eq 'java.lang.MultiLineString'}">
                                                            <p:ajax event="blur" update="@parent" partialSubmit="true"/>
                                                        </p:inputTextarea> 
                                                        <p:inputText  value="#{a.value}" styleClass="xLarge span4" required="#{a.property.required}" label="#{a.property.label}" 
                                                                      rendered="#{a.property.type eq 'java.lang.String'}">
                                                            <f:validator validatorId="#{not empty a.property.validator ?  a.property.validator : 'safeTextUTF8Validator'}"/>
                                                        </p:inputText>                                                         
                                                        <pe:inputNumber value="#{a.value}" styleClass="xLarge span4" required="#{a.property.required}" label="#{a.property.label}"
                                                                        rendered="#{a.property.type eq 'java.lang.Long' or type eq 'java.lang.Double' or type eq 'java.lang.Float'}">  
                                                            <p:ajax event="blur" update="@parent" partialSubmit="true"/>
                                                        </pe:inputNumber>  
                                                        <p:selectOneMenu value="#{a.value}" effect="fade"  converter="#{omnifaces.SelectItemsConverter}" required="#{a.property.required}" requiredMessage="#{a.property.requiredMessage}" label="#{a.property.label}"
                                                                         rendered="#{a.property.type eq 'java.lang.String[]'}">  
                                                            <f:selectItems value="#{ui.getValuesAsSelectItem(a.property.values)}" var="v" itemLabel="#{v.label}" itemValue="#{v}"/>  
                                                            <p:ajax event="change" update="@parent" partialSubmit="true"/>
                                                        </p:selectOneMenu> 
                                                    </div>
                                                </h:panelGroup>  
                                            </c:when>                                            
                                            <c:otherwise>
                                                <h:panelGroup rendered="#{not a.property.survey}" layout="block" >
                                                    <label for="#{a.name}" class="#{(not empty a.property.required and a.property.required) ? 'required' : ''}"><strong>#{a.property.label}#{(not empty a.property.required and a.property.required) ? '*&#160;' : '&nbsp;'}</strong></label>                                            
                                                    <div class="span1" >                                                                                     

                                                        <p:selectBooleanCheckbox value="#{a.value}" rendered="#{a.property.type eq 'java.lang.Boolean'}" required="#{a.property.required}">
                                                            <p:ajax event="change" update="@parent" partialSubmit="true"/>
                                                        </p:selectBooleanCheckbox>                                                        
                                                        <p:inputText  value="#{a.value}" styleClass="xLarge span4" required="#{a.property.required}" label="#{a.property.label}" 
                                                                      rendered="#{a.property.type eq 'java.lang.String'}">
                                                            <f:validator validatorId="#{not empty a.property.validator ?  a.property.validator : 'safeTextUTF8Validator'}"/>
                                                        </p:inputText>                                                        
                                                        <pe:inputNumber value="#{a.value}" styleClass="xLarge span4" required="#{a.property.required}" label="#{a.property.label}"
                                                                        rendered="#{a.property.type eq 'java.lang.Long' or type eq 'java.lang.Double' or type eq 'java.lang.Float'}">  
                                                            <p:ajax event="blur" update="@parent" partialSubmit="true"/>
                                                        </pe:inputNumber>  
                                                        <p:selectOneMenu value="#{a.value}" effect="fade"  converter="#{omnifaces.SelectItemsConverter}" required="#{a.property.required}" requiredMessage="#{a.property.requiredMessage}" label="#{a.property.label}"
                                                                         rendered="#{a.property.type eq 'java.lang.String[]'}">  
                                                            <f:selectItems value="#{ui.getValuesAsSelectItem(a.property.values)}" var="v" itemLabel="#{v.label}" itemValue="#{v}"/>  
                                                            <p:ajax event="change" update="@parent" partialSubmit="true"/>
                                                        </p:selectOneMenu> 
                                                    </div>
                                                </h:panelGroup>  
                                            </c:otherwise>
                                        </c:choose>

                                    </ui:repeat>
                                    <br/><br/>
                                    <div class="span14">                                
                                        <c:choose> 
                                            <c:when test="#{(f.name eq 'antecedentesPersonalesFichaMedica')}">                                                           
                                                <h:panelGroup id="obapPanel" layout="block" class="clearfix">
                                                    <label for="obap1">#{'Observación Antecedentes Personales'}</label>
                                                    <div class="input">
                                                        <p:inputTextarea id="obap1" value="#{fichaMedicaHome.instance.observacionAntecedentesPersonales}" styleClass="xLarge span6" required="false" style="width: 600px; height: 80px;" 
                                                                         rendered="true">
                                                            <p:ajax event="blur" update="@parent" partialSubmit="true"/>
                                                        </p:inputTextarea>                                              
                                                    </div>
                                                </h:panelGroup> 
                                            </c:when>                                
                                            <c:when test="#{(f.name eq 'antecedentesFamiliaresFichaMedica')}">                                                            
                                                <h:panelGroup id="obafPanel" layout="block" class="clearfix">
                                                    <label for="obaf1">#{'Observación Antecedentes Familiares'}</label>
                                                    <div class="input">
                                                        <p:inputTextarea id="obaf1" value="#{fichaMedicaHome.instance.observacionAntecedentesFamiliares}" styleClass="xLarge span6" required="false" style="width: 600px; height: 80px;" 
                                                                         rendered="true">
                                                            <p:ajax event="blur" update="@parent" partialSubmit="true"/>
                                                        </p:inputTextarea>                                              
                                                    </div>
                                                </h:panelGroup> 
                                            </c:when>
                                        </c:choose> 
                                    </div>
                                </c:when>
                            </c:choose> 
                        </p:tab>
                    </c:forEach>
                    <!--Evolucion o consultas medicas-->
                    <p:tab title="#{messages['consultaMedica.title']}" rendered="#{fichaMedicaHome.instance.persistent}" disabled="false">                        

                        <div class="admin-actions">
                            <h:link value="#{messages['common.add']}" rendered="#{true}" outcome="consultaMedica" styleClass="btn primary">
                                <f:param name="fichaMedicaId" value="#{fichaMedicaHome.instance.id}"></f:param>
                                <f:param name="pacienteId" value="#{fichaMedicaHome.paciente.id}"></f:param>
                                <f:param name="backView" value="fichaMedica"></f:param>
                            </h:link>
                            #{' '}
                            <h:link id="button-edit" value="#{messages['common.edit']}" rendered="#{true}" outcome="consultaMedica" styleClass="btn"
                                    disabled="#{fichaMedicaHome.consultaMedica == null}" >
                                <f:param name="fichaMedicaId" value="#{fichaMedicaHome.instance.id}"></f:param>
                                <f:param name="pacienteId" value="#{fichaMedicaHome.paciente.id}"></f:param>
                                <f:param name="backView" value="fichaMedica"></f:param>
                            </h:link>
                        </div> 
                        <p:dataTable id="tablaConsultasM" value="#{fichaMedicaHome.listaConsultasM}" rows="10" var="consultaM_"
                                     selection="single" selectionMode="#{fichaMedicaHome.consultaMedica}"
                                     rowKey="#{consultaM_.id}" paginator="true">                            


                            <p:column headerText="Id">
                                <h:outputText value="#{consultaM_.id}"/>
                            </p:column>                            
                            <p:column headerText="#{messages['consultaMedica.fechaConsulta']}">
                                <p:calendar value="#{consultaM_.fechaConsulta}"/>
                            </p:column>
                            <p:column headerText="#{messages['consultaMedica.motivo']}">
                                <h:outputText value="#{consultaM_.motivoConsulta}" styleClass="span3"/>
                            </p:column>
                            <p:column headerText="#{messages['consultaMedica.enfermedadActual']}">
                                <h:outputText value="#{consultaM_.enfermedadActual}"/>
                            </p:column>  
                        </p:dataTable>
                    </p:tab>
                </p:accordionPanel> 
                
                <div class="admin-actions span15" style="padding-right: 40px;">
                    <br/>
                    <p:commandButton id="save" action="#{fichaMedicaHome.guardar()}" value="#{messages['common.save']}" styleClass="btn primary offset4"
                                     immediate="true"/>
                    &nbsp;&nbsp;
                    <h:link outcome="/pages/home.xhtml?faces-redirect=true" 
                            value="#{messages['common.cancel']}" styleClass="btn primary" >                         
                    </h:link>
                </div>
                <div class="offset8" style="float: right">
                    <glue:output id="respons" name="responsable" type="text" label="Responsable" value="#{fichaMedicaHome.instance.responsable.fullName}" 
                                 required="false" execute="@this" render="edad" styleClass="xLarge" disabled="true"/>
                </div>
            </h:form>
        </ui:define>
    </ui:composition>
</html>                
